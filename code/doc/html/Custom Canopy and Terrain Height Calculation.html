<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2022b"><title>Untitled</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S1 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S2 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S3 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }
.S4 { margin: 15px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 0 10px 0; }
.S5 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 1px solid rgb(191, 191, 191); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S6 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S7 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(191, 191, 191); border-radius: 0px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S8 { color: rgb(33, 33, 33); padding: 10px 0px 6px 17px; background: rgb(255, 255, 255) none repeat scroll 0% 0% / auto padding-box border-box; font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px; overflow-x: hidden; line-height: 17.234px;  }
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsErrorElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsErrorElement .diagnosticMessage-errorType {    overflow: auto;}
.embeddedOutputsErrorElement.inlineElement {}
.embeddedOutputsErrorElement.rightPaneElement {}
/* Styling that is common to warnings and errors is in diagnosticOutput.css */.embeddedOutputsWarningElement {    min-height: 18px;    max-height: 550px;}
.embeddedOutputsWarningElement .diagnosticMessage-warningType {    overflow: auto;}
.embeddedOutputsWarningElement.inlineElement {}
.embeddedOutputsWarningElement.rightPaneElement {}
/* Copyright 2015-2019 The MathWorks, Inc. *//* In this file, styles are not scoped to rtcContainer since they could be in the Dojo Tooltip */.diagnosticMessage-wrapper {    font-family: Menlo, Monaco, Consolas, "Courier New", monospace;    font-size: 12px;}
.diagnosticMessage-wrapper.diagnosticMessage-warningType {    color: rgb(255,100,0);}
.diagnosticMessage-wrapper.diagnosticMessage-warningType a {    color: rgb(255,100,0);    text-decoration: underline;}
.diagnosticMessage-wrapper.diagnosticMessage-errorType {    color: rgb(230,0,0);}
.diagnosticMessage-wrapper.diagnosticMessage-errorType a {    color: rgb(230,0,0);    text-decoration: underline;}
.diagnosticMessage-wrapper .diagnosticMessage-messagePart,.diagnosticMessage-wrapper .diagnosticMessage-causePart {    white-space: pre-wrap;}
.diagnosticMessage-wrapper .diagnosticMessage-stackPart {    white-space: pre;}
.embeddedOutputsTextElement,.embeddedOutputsVariableStringElement {    white-space: pre;    word-wrap:  initial;    min-height: 18px;    max-height: 550px;}
.embeddedOutputsTextElement .textElement,.embeddedOutputsVariableStringElement .textElement {    overflow: auto;}
.textElement,.rtcDataTipElement .textElement {    padding-top: 2px;}
.embeddedOutputsTextElement.inlineElement,.embeddedOutputsVariableStringElement.inlineElement {}
.inlineElement .textElement {}
.embeddedOutputsTextElement.rightPaneElement,.embeddedOutputsVariableStringElement.rightPaneElement {    min-height: 16px;}
.rightPaneElement .textElement {    padding-top: 2px;    padding-left: 9px;}
.S9 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 1px solid rgb(191, 191, 191); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S10 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(191, 191, 191); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S11 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }
.S12 { margin: 10px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 15px; font-weight: 700; text-align: left;  }
.S13 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 15px; font-weight: 700; text-align: left;  }
.S14 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }</style></head><body><div class = rtcContent><h2  class = 'S0' id = 'H_08F81F22' ><span>Customized canopy and terrain height calculation</span></h2><div  class = 'S1'><span>Version 5 of the ATL08 product provides measurements of canopy and terrain heights in predetermined 20 m and 100 m segments. However, with the xATLy toolbox, you can go beyond these fixed segment lengths and customize your own preferred segment lengths while also controlling the number of data points to use in your calculations. </span></div><div  class = 'S1'><span>This notebook will guide you through the process of utilizing the toolbox to compute canopy and terrain heights in custom segment lengths.</span></div><ol  class = 'S2'><li  class = 'S3'><a href = "#H_32676B56"><span>Creating Atl03, Atl08 and ground track objects</span></a></li><li  class = 'S3'><a href = "#H_E2BCB12B"><span>Steps for customized calculation of  canopy and terrain heights</span></a></li><li  class = 'S3'><a href = "#H_1AEFA7CC"><span>Saving calculated canopy and terrain heights</span></a></li><li  class = 'S3'><a href = "#H_6AD926FA"><span>Generating custom segment polygons</span></a></li><li  class = 'S3'><a href = "#H_F06DA9C5"><span>Concluding remarks</span></a></li></ol><h3  class = 'S4' id = 'H_32676B56' ><span>Create Atl03, Atl08 and ground track objects</span></h3><div  class = 'S1'><span>For this activity, you will be working with an ATL03/ATL08 granule obtained in 2019 from a region in northwestern Zambia. However, you may choose to use a different granule, but be sure to modify the file paths accordingly.</span></div><div  class = 'S1'><span>Create </span><span style=' font-family: monospace;'>Atl03</span><span> and </span><span style=' font-family: monospace;'>Atl08</span><span> objects using file paths provided below. </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >atl03path = </span><span style="color: rgb(167, 9, 245);">"../data/ATL03_20190603025340_10050314_002_01.h5"</span><span >; </span><span style="color: rgb(0, 128, 19);">% ATL03 filepath</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atl08path = </span><span style="color: rgb(167, 9, 245);">"../data/ATL08_20190603025340_10050314_002_01.h5"</span><span >; </span><span style="color: rgb(0, 128, 19);">% ATL08 filepath</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% create an Atl03 and Atl08 objects</span></span></div></div><div class="inlineWrapper outputs"><div  class = 'S7'><span style="white-space: pre"><span >a3 = Atl03(atl03path);</span></span></div><div  class = 'S8'><div class="inlineElement eoOutputWrapper embeddedOutputsErrorElement" uid="45C2778E" prevent-scroll="true" data-testid="output_0" style="width: 1139px; white-space: normal; font-style: normal; color: rgb(33, 33, 33); font-size: 12px;"><div class="diagnosticMessage-wrapper diagnosticMessage-errorType eoOutputContent" data-width="1109" data-height="17" data-hashorizontaloverflow="false" style="max-height: 261px; white-space: normal; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"><div class="diagnosticMessage-messagePart" style="white-space: pre-wrap; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;">Method 'Atl03' is not defined for class 'Atl03' or is removed from MATLAB's search path.</div><div class="diagnosticMessage-stackPart" style="white-space: pre; font-style: normal; color: rgb(183, 49, 44); font-size: 12px;"></div></div></div></div></div><div class="inlineWrapper"><div  class = 'S9'><span style="white-space: pre"><span >a8 = Atl08(atl08path);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% create ground track object. Here we select the srtong beeam from middle</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% ground track pair, gt2l. To see available you may use a3.gettracklist() </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% or a8.gettracklist();% The track you choose must be available in Atl03 </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% and Atl08 objects</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >gt = gtrack(</span><span style="color: rgb(167, 9, 245);">'gt1l'</span><span >,a3,a8);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% visualize section of the data</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [0,2000];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure(</span><span style="color: rgb(167, 9, 245);">'units'</span><span >,</span><span style="color: rgb(167, 9, 245);">'normalized'</span><span >,</span><span style="color: rgb(167, 9, 245);">'outerposition'</span><span >,[0.0 0.0 0.85 0.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% plot raw point cloud with signal confidence rendering </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(gt,</span><span style="color: rgb(167, 9, 245);">'s'</span><span >,[],atdlim) </span><span style="color: rgb(0, 128, 19);">% group points by signal confidence, use default colors</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >box </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >ylim([1050,1150])</span></span></div></div></div><h3  class = 'S11' id = 'H_E2BCB12B' ><span>Calculate canopy and terrain heights</span></h3><div  class = 'S1'><span>The process of calculating canopy and terrain heights typically involves multiple steps, such as obtaining a classified point cloud, fitting the ground level, normalizing the aboveground height, and computing the canopy and terrain metrics. While the </span><span style=' font-family: monospace;'>getnormalizedpc </span><span>method can handle the first three steps with a single function call, a more detailed and informative approach is provided below, where each step is broken down and explained, allowing for a better understanding of the parameters being used.</span></div><h4  class = 'S12'><span style=' font-style: italic;'>1. Retrieve classified point cloud using </span><span style=' font-family: monospace;'>getclassedpc</span><span style=' font-style: italic;'> method.</span></h4><div  class = 'S1' id = 'H_57B2629C' ><span style=' font-style: italic;'> </span><span>The </span><span style=' font-family: monospace;'>getclassedpc</span><span> method serves the purpose of retrieving a classified point cloud by merging the ATL08 photon classes (classed_pc_flag) with the raw ATL03 point cloud. Along with the </span><span style=' font-family: monospace;'>Atl03</span><span> and </span><span style=' font-family: monospace;'>Atl08</span><span> objects, the method takes two optional parameters:</span></div><ul  class = 'S2'><li  class = 'S3'><span>inc_these_seg_attrib: This parameter allows for the inclusion of ATL08 segment-level attributes in the point cloud.</span></li><li  class = 'S3'><span>clip_aoi: Enabling this parameter results in the returned point cloud being clipped to a specific area of interest.</span></li></ul><div  class = 'S1'><span>In this demonstration, we will include the msw_flag and night_flag to provide further information on atmospheric scattering and night/day acquisition. </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >inc_these_seg_attrib = {</span><span style="color: rgb(167, 9, 245);">'msw_flag'</span><span >,</span><span style="color: rgb(167, 9, 245);">'night_flag'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >pc = getclassedpc(gt,inc_these_seg_attrib);</span><span style="color: rgb(0, 128, 19);">% No clipping to area of interest</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% display table columns</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >disp(string(pc.Properties.VariableNames)')</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% visualize section of the data</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [0,2000];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >mksize =  3;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure(</span><span style="color: rgb(167, 9, 245);">'units'</span><span >,</span><span style="color: rgb(167, 9, 245);">'normalized'</span><span >,</span><span style="color: rgb(167, 9, 245);">'outerposition'</span><span >,[0.0 0.0 0.85 0.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% plot classified point cloud </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >plothis = </span><span style="color: rgb(167, 9, 245);">'c'</span><span >; </span><span style="color: rgb(0, 128, 19);">% photn class</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >colors = </span><span style="color: rgb(167, 9, 245);">'krgm'</span><span >; </span><span style="color: rgb(0, 128, 19);">% black for noise,red = terrain etc</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >excludenoisepts = false; </span><span style="color: rgb(0, 128, 19);">% includes noise points</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(gt,plothis, colors, atdlim, excludenoisepts) </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >box </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >ylim([1050,1150])</span></span></div></div></div><h4  class = 'S13' id = 'H_A08099F8' ><span style=' font-style: italic;'>2. Fit ground level using the </span><span style=' font-family: monospace;'>fitgroundmodel</span><span style=' font-style: italic;'> function. </span></h4><div  class = 'S1'><span>Since ICESat-2 measures along tracks, the xATLy toolbox models terrain surfaces as one-dimensional curves, following these steps:</span></div><ul  class = 'S2'><li  class = 'S3'><span>Terrain points are extracted from the classified point cloud and used to create curves, with along-track distance and elevation serving as x- and y-axis values, respectively.</span></li><li  class = 'S3'><span>In order to generate smoother curves through the points, the terrain points are binned at fixed interval distances.</span></li><li  class = 'S3'><span>The representative elevation value for each bin is calculated as the median elevation value.</span></li><li  class = 'S3'><span>A curve is interpolated to connect all the bin elevations, utilizing a specified interpolation method.</span></li></ul><div  class = 'S1'><span>In the xATLy toolbox, the </span><span style=' font-family: monospace;'>fitgroundmodel</span><span> function is utilized to fit a curve to the terrain points, resulting in both a curve fit object or function (grndFunc), as well as the ground points (gpts) utilized during the fitting process, as shown below.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% fit ground level</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >grndInterval = 10; </span><span style="color: rgb(0, 128, 19);">% binning distance</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >interpolatemethod = </span><span style="color: rgb(167, 9, 245);">'smoothingspline'</span><span >;</span><span style="color: rgb(0, 128, 19);">%'other options 'linearinterp','cubicspline';</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >robustfit = false; </span><span style="color: rgb(0, 128, 19);">% no robust fitting using RANSAC. This is still experimnetal</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >[grndFunc, gpts] = fitgroundmodel(pc,grndInterval,interpolatemethod,robustfit);</span></span></div></div></div><div  class = 'S1'><span>The following lines of code plot the point cloud together with the fitted ground curve. We use tiled layout to show zoomed views of two sections of the data to clearly show details on the binning and fitting.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% Visualize fitted ground surface</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure(</span><span style="color: rgb(167, 9, 245);">'units'</span><span >,</span><span style="color: rgb(167, 9, 245);">'normalized'</span><span >,</span><span style="color: rgb(167, 9, 245);">'outerposition'</span><span >,[0.0 0.0 0.85 1]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >t = tiledlayout(2,2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >nexttile(1,[1,2])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [0,2000];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >mksize =  7;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >plothis = </span><span style="color: rgb(167, 9, 245);">'c'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(pc,plothis, colors, atdlim, excludenoisepts); </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cf = and(gpts(:,1) &gt;= atdlim(1),gpts(:,1) &lt;=atdlim(2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); </span><span style="color: rgb(0, 128, 19);">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >set(hh,</span><span style="color: rgb(167, 9, 245);">'MarkerSize'</span><span >,mksize, </span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,1.5);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg = hh(1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.DisplayName = </span><span style="color: rgb(167, 9, 245);">'Bin points'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Color = [0.6353 0.0784 0.1843];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.MarkerSize = mksize;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Marker = </span><span style="color: rgb(167, 9, 245);">'x'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.LineWidth = 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg = hh(2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg.DisplayName = </span><span style="color: rgb(167, 9, 245);">'Terrain fit'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg.Color = [ 0.9412,0.8824,0.2275];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlabel(</span><span style="color: rgb(167, 9, 245);">'Along-track distance (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylabel(</span><span style="color: rgb(167, 9, 245);">'Elevation (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg2 = legend(</span><span style="color: rgb(167, 9, 245);">'Orientation'</span><span >,</span><span style="color: rgb(167, 9, 245);">'horizontal'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Location'</span><span >,</span><span style="color: rgb(167, 9, 245);">'southwest'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NumColumns'</span><span >,3,</span><span style="color: rgb(167, 9, 245);">'FontSize'</span><span >,8);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg2.ItemTokenSize(1) = 10;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylim([1000,1160])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >nexttile</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [400,500];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(pc,plothis, colors, atdlim, excludenoisepts); </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cf = and(gpts(:,1) &gt;= atdlim(1),gpts(:,1) &lt;=atdlim(2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); </span><span style="color: rgb(0, 128, 19);">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >set(hh,</span><span style="color: rgb(167, 9, 245);">'MarkerSize'</span><span >,mksize, </span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,1.5);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg = hh(1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Color = [0.6353 0.0784 0.1843];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.MarkerSize = mksize;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Marker = </span><span style="color: rgb(167, 9, 245);">'x'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.LineWidth = 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg = hh(2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg.Color = [ 0.9412,0.8824,0.2275];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg2 = legend(</span><span style="color: rgb(167, 9, 245);">'off'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >title(</span><span style="color: rgb(167, 9, 245);">''</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >subtitle(</span><span style="color: rgb(167, 9, 245);">''</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlabel(</span><span style="color: rgb(167, 9, 245);">'Along-track distance (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylabel(</span><span style="color: rgb(167, 9, 245);">'Elevation (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylim([1000,1160])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >nexttile</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [1200,1300];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(pc,plothis, colors, atdlim, excludenoisepts); </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cf = and(gpts(:,1) &gt;= atdlim(1),gpts(:,1) &lt;=atdlim(2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); </span><span style="color: rgb(0, 128, 19);">%</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >set(hh,</span><span style="color: rgb(167, 9, 245);">'MarkerSize'</span><span >,mksize, </span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,1.5);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg = hh(1);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Color = [0.6353 0.0784 0.1843];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.MarkerSize = mksize;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.Marker = </span><span style="color: rgb(167, 9, 245);">'x'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >dg.LineWidth = 1;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg = hh(2);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cg.Color = [ 0.9412,0.8824,0.2275];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg2 = legend(</span><span style="color: rgb(167, 9, 245);">'off'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlabel(</span><span style="color: rgb(167, 9, 245);">'Along-track distance (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylabel(</span><span style="color: rgb(167, 9, 245);">'Elevation (m)'</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >title(</span><span style="color: rgb(167, 9, 245);">''</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >subtitle(</span><span style="color: rgb(167, 9, 245);">''</span><span >)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ylim([1000,1160])</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >t.TileSpacing = </span><span style="color: rgb(167, 9, 245);">'compact'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >t.Padding = </span><span style="color: rgb(167, 9, 245);">'compact'</span><span >;</span></span></div></div></div><h4  class = 'S13' id = 'H_F26C3CA5' ><span>3. Normalize point cloud using </span><span style=' font-family: monospace;'>normalizepts</span><span> function</span></h4><div  class = 'S1'><span>Using the </span><span style=' font-family: monospace;'>normalizepts</span><span> function, the fitted ground curve model is employed to estimate the ground level at each point. This estimated ground level is then subtracted from the point elevation, resulting in the aboveground level heights. Any points below the fitted ground curve will have negative aboveground heights. The </span><span style=' font-style: italic;'>removeptsbelow</span><span> parameter provides the option to either remove or retain these points with negative heights, as demonstrated below.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >removeptsbelow = true; </span><span style="color: rgb(0, 128, 19);">% gets rid of any point below fitted ground level</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >npc = normalizepts(pc,grndFunc, removeptsbelow);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% Visualize output</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [0,2000];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >mksize =  3;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure(</span><span style="color: rgb(167, 9, 245);">'units'</span><span >,</span><span style="color: rgb(167, 9, 245);">'normalized'</span><span >,</span><span style="color: rgb(167, 9, 245);">'outerposition'</span><span >,[0.0 0.0 0.85 0.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% plot classified point cloud </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >plothis = </span><span style="color: rgb(167, 9, 245);">'n'</span><span >; </span><span style="color: rgb(0, 128, 19);">% photn class</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >colors = </span><span style="color: rgb(167, 9, 245);">'rgm'</span><span >; </span><span style="color: rgb(0, 128, 19);">% black for noise,red = terrain etc</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >excludenoisepts = true; </span><span style="color: rgb(0, 128, 19);">% includes noise points</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(gt,plothis, colors, atdlim, excludenoisepts) </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >box </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >ylim([0,25])</span></span></div></div></div><h4  class = 'S13' id = 'H_F3CB20B0' ><span>4. Calculate canopy and terrain height using the h</span><span style=' font-family: monospace;'>metrics</span><span> function</span></h4><div  class = 'S1'><span>With the </span><span style=' font-family: monospace;'>hmetrics</span><span> function, canopy and terrain metrics are computed for each segment utilizing normalized point cloud data. The function allows for the specification of a segment length as well as a minimum number of points required for a valid calculation. Additionally, multiple canopy height percentiles can be included, and the minimum allowable canopy height can be controlled as desired.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% calculation parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >segLength = 30; </span><span style="color: rgb(0, 128, 19);">% use 30 m segment length</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >canopy_percentiles = [50,98]; </span><span style="color: rgb(0, 128, 19);">% calculate 50th and 98th canopy height percentiles</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >minpts = 9; </span><span style="color: rgb(0, 128, 19);">% set min number of points for valid calculation</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >min_h = 2; </span><span style="color: rgb(0, 128, 19);">% set min canopy height returned</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >includeground = true; </span><span style="color: rgb(0, 128, 19);">% includes ground points in canopy height percentile calculation</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% calculate canopy and terrain heights</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cH = hmetrics(npc, segLength,canopy_percentiles,minpts,min_h, includeground);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% display first 5 rows, limt columns for space to:</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% 1:4 -&gt; seg_id, seg_atd, seg_lon, seg_lat</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% 9:11 - &gt; seg_npts, seg_ca_pts, seg_te_pts</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% 17 -&gt; h_ca_p98 (98th percentile canopy height)</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >disp(cH(1:5,[1:4,9:11,17])) </span></span></div></div></div><div  class = 'S14'><span>The </span><span style=' font-family: monospace;'>hmetrics</span><span> function outputs various attributes by default, including the central segment coordinates (seg_lat/seg_lon), as well as the coordinates marking the beginning (seg_lat_beg/seg_lon_beg) and end (seg_lat_end/seg_lon_end) of the segment. The resulting table also includes information on the number of points within the segment (seg_npts), which is further broken down into terrain (seg_te_pts) and off-terrain canopy (seg_ca_pts). Additionally, the function calculates default metrics such as the minimum, mean, maximum, and standard deviation for both canopy and terrain heights.</span></div><div  class = 'S1'><span>The figure below shows normalized point cloud data overlain with the calculated 98th percentile canopy height.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% visualize output</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdlim = [0,2000];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >mksize =  3;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >figure(</span><span style="color: rgb(167, 9, 245);">'units'</span><span >,</span><span style="color: rgb(167, 9, 245);">'normalized'</span><span >,</span><span style="color: rgb(167, 9, 245);">'outerposition'</span><span >,[0.2 0.0 0.85 0.6]);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% plot classified point cloud </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >plothis = </span><span style="color: rgb(167, 9, 245);">'n'</span><span >; </span><span style="color: rgb(0, 128, 19);">% photn class</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >colors = </span><span style="color: rgb(167, 9, 245);">'rgm'</span><span >; </span><span style="color: rgb(0, 128, 19);">% black for noise,red = terrain etc</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >excludenoisepts = true; </span><span style="color: rgb(0, 128, 19);">% includes noise points</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% normalized point cloud</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >atdplot(npc,plothis, colors, atdlim, excludenoisepts) </span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >box </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% overlay with calculated 98th percentile height</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">on</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >clr = [0.4667 0.6745 0.1882];</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >ch = </span><span style="color: rgb(167, 9, 245);">'RH98'</span><span >; </span><span style="color: rgb(0, 128, 19);">% 98th percentile height;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >tf2 = and(cH.seg_atd &gt;= atdlim(1), cH.seg_atd &lt;= atdlim(2));</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >plot(cH.seg_atd(tf2),cH.h_ca_p98(tf2),</span><span style="color: rgb(167, 9, 245);">'^'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Color'</span><span >,clr,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >                </span><span style="color: rgb(167, 9, 245);">'MarkerSize'</span><span >,7,</span><span style="color: rgb(167, 9, 245);">'LineWidth'</span><span >,2,</span><span style="color: rgb(167, 9, 245);">'DisplayName'</span><span >,ch)</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >hold </span><span style="color: rgb(167, 9, 245);">off</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg3 = legend(</span><span style="color: rgb(167, 9, 245);">'Orientation'</span><span >,</span><span style="color: rgb(167, 9, 245);">'vertical'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Location'</span><span >,</span><span style="color: rgb(167, 9, 245);">'best'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NumColumns'</span><span >,2,</span><span style="color: rgb(167, 9, 245);">'FontSize'</span><span >,8);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >lg3.ItemTokenSize(1) = 10;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >xlim([atdlim(1),atdlim(2)])</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >ylim([0,30])</span></span></div></div></div><h4  class = 'S13'><span>Combining steps 1 -3</span></h4><div  class = 'S1'><span>In case you are only interested in calculating heights, steps 1 - 3 can be combined as follows:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >inc_these_seg_attrib = {</span><span style="color: rgb(167, 9, 245);">'msw_flag'</span><span >,</span><span style="color: rgb(167, 9, 245);">'night_flag'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >clip_aoi = []; </span><span style="color: rgb(0, 128, 19);">% no clipping enabled</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >grndInterval = 10;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >interpolatemethod = </span><span style="color: rgb(167, 9, 245);">'smoothingspline'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >robustfit = false;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >removeptsbelow = true;</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% get normalized points directly</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >npc = gt.getnormalizedpc(inc_these_seg_attrib, clip_aoi, grndInterval,</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >                interpolatemethod,robustfit, removeptsbelow);</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% calculation parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >segLength = 30; </span><span style="color: rgb(0, 128, 19);">% use 30 m segment length</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >pcTile = [50,98]; </span><span style="color: rgb(0, 128, 19);">% calculate 50th and 98th canopy height percentiles</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >minPts = 9; </span><span style="color: rgb(0, 128, 19);">% set min number of points for valid calculation</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >minCH = 2; </span><span style="color: rgb(0, 128, 19);">% set min canopy height returned</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >includeground = true; </span><span style="color: rgb(0, 128, 19);">% includes ground points in canopy height percentile calculation</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span style="color: rgb(0, 128, 19);">% calculate canopy and terrain heights</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >cH = hmetrics(npc, segLength,pcTile,minPts,minCH, includeground);</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >disp(cH(1:5,[1:4,9:11,17])) </span><span style="color: rgb(0, 128, 19);">% display first 10 rows, limit columns</span></span></div></div></div><h3  class = 'S11' id = 'H_1AEFA7CC' ><span>Saving calculated canopy and terrain heights</span></h3><div  class = 'S1'><span>Similar to all derived attribute data, calculated canopy and terrain height metrics can readily be saved as ASCII text files to facilitate further analyses. The code below saves the </span><span style=' font-style: italic;'>cH</span><span> table retrieved in the preceding steps to a CSV file using the </span><span style=' font-family: monospace;'>savetable</span><span> function</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >pc_fn = </span><span style="color: rgb(167, 9, 245);">'./temp/gt1l_tbl_ch.csv'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >savetable(cH,pc_fn) </span><span style="color: rgb(0, 128, 19);">% writes the classified pc</span></span></div></div></div><h3  class = 'S4' id = 'H_6AD926FA' ><span>Generate custom segment polygons</span></h3><div  class = 'S1'><span>Similar to ATL08 data, the xATLy toolbox allows for the creation of segment polygons based on the custom canopy height data. These polygons can be used for various tasks, including validation or metric comparison, as well as visualization purposes. To generate these segment polygons, the toolbox utilizes the beginning and end coordinates of each segment in addition to a set segment width that approximates the lidar footprint.</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >segmentwidth = 11; </span><span style="color: rgb(0, 128, 19);">% sets output segment width to 11 m</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >outshp = </span><span style="color: rgb(167, 9, 245);">'.\temp\customseg.shp'</span><span >; </span><span style="color: rgb(0, 128, 19);">% output shapefile, WGS84 geo</span></span></div></div><div class="inlineWrapper"><div  class = 'S6'><span style="white-space: pre"><span >clip_aoi = []; </span><span style="color: rgb(0, 128, 19);">% no clipping to area of interest</span></span></div></div><div class="inlineWrapper"><div  class = 'S10'><span style="white-space: pre"><span >writecustomsegpol(cH, outshp, segmentwidth, clip_aoi)</span></span></div></div></div><h3  class = 'S4' id = 'H_F06DA9C5' ><span>Concluding remarks</span></h3><div  class = 'S1'><span>This notebook showcased the use of the xATLy toolbox for generating custom canopy and terrain heights using ATL03 and ATL08 data. However, it's important to note that the current version of the toolbox utilizes the ATL08 photon classification data without any refinement. As a result, any errors in the ATL08 product's classification may impact the accuracy of the derived canopy and terrain heights.</span></div><div  class = 'S1'><span>For additional processing options, please refer to the class methods or function definitions provided in the xATLy toolbox.</span></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Customized canopy and terrain height calculation
% Version 5 of the ATL08 product provides measurements of canopy and terrain 
% heights in predetermined 20 m and 100 m segments. However, with the xATLy toolbox, 
% you can go beyond these fixed segment lengths and customize your own preferred 
% segment lengths while also controlling the number of data points to use in your 
% calculations. 
% 
% This notebook will guide you through the process of utilizing the toolbox 
% to compute canopy and terrain heights in custom segment lengths.
%% 
% # Creating Atl03, Atl08 and ground track objects
% # Steps for customized calculation of  canopy and terrain heights
% # Saving calculated canopy and terrain heights
% # Generating custom segment polygons
% # Concluding remarks
% Create Atl03, Atl08 and ground track objects
% For this activity, you will be working with an ATL03/ATL08 granule obtained 
% in 2019 from a region in northwestern Zambia. However, you may choose to use 
% a different granule, but be sure to modify the file paths accordingly.
% 
% Create |Atl03| and |Atl08| objects using file paths provided below. 

atl03path = "../data/ATL03_20190603025340_10050314_002_01.h5"; % ATL03 filepath
atl08path = "../data/ATL08_20190603025340_10050314_002_01.h5"; % ATL08 filepath

% create an Atl03 and Atl08 objects
a3 = Atl03(atl03path);
a8 = Atl08(atl08path);

% create ground track object. Here we select the srtong beeam from middle
% ground track pair, gt2l. To see available you may use a3.gettracklist() 
% or a8.gettracklist();% The track you choose must be available in Atl03 
% and Atl08 objects

gt = gtrack('gt1l',a3,a8);

% visualize section of the data
atdlim = [0,2000];

figure('units','normalized','outerposition',[0.0 0.0 0.85 0.6]);

% plot raw point cloud with signal confidence rendering 
atdplot(gt,'s',[],atdlim) % group points by signal confidence, use default colors
box on
xlim([atdlim(1),atdlim(2)])
ylim([1050,1150])
% Calculate canopy and terrain heights
% The process of calculating canopy and terrain heights typically involves multiple 
% steps, such as obtaining a classified point cloud, fitting the ground level, 
% normalizing the aboveground height, and computing the canopy and terrain metrics. 
% While the |getnormalizedpc| method can handle the first three steps with a single 
% function call, a more detailed and informative approach is provided below, where 
% each step is broken down and explained, allowing for a better understanding 
% of the parameters being used.
% _1. Retrieve classified point cloud using_ |getclassedpc| _method._
% The |getclassedpc| method serves the purpose of retrieving a classified point 
% cloud by merging the ATL08 photon classes (classed_pc_flag) with the raw ATL03 
% point cloud. Along with the |Atl03| and |Atl08| objects, the method takes two 
% optional parameters:
%% 
% * inc_these_seg_attrib: This parameter allows for the inclusion of ATL08 segment-level 
% attributes in the point cloud.
% * clip_aoi: Enabling this parameter results in the returned point cloud being 
% clipped to a specific area of interest.
%% 
% In this demonstration, we will include the msw_flag and night_flag to provide 
% further information on atmospheric scattering and night/day acquisition. 

inc_these_seg_attrib = {'msw_flag','night_flag'};
pc = getclassedpc(gt,inc_these_seg_attrib);% No clipping to area of interest

% display table columns
disp(string(pc.Properties.VariableNames)')

% visualize section of the data
atdlim = [0,2000];
mksize =  3;

figure('units','normalized','outerposition',[0.0 0.0 0.85 0.6]);

% plot classified point cloud 
plothis = 'c'; % photn class
colors = 'krgm'; % black for noise,red = terrain etc
excludenoisepts = false; % includes noise points

atdplot(gt,plothis, colors, atdlim, excludenoisepts) 
box on
xlim([atdlim(1),atdlim(2)])
ylim([1050,1150])
% _2. Fit ground level using the_ |fitgroundmodel| _function._ 
% Since ICESat-2 measures along tracks, the xATLy toolbox models terrain surfaces 
% as one-dimensional curves, following these steps:
%% 
% * Terrain points are extracted from the classified point cloud and used to 
% create curves, with along-track distance and elevation serving as x- and y-axis 
% values, respectively.
% * In order to generate smoother curves through the points, the terrain points 
% are binned at fixed interval distances.
% * The representative elevation value for each bin is calculated as the median 
% elevation value.
% * A curve is interpolated to connect all the bin elevations, utilizing a specified 
% interpolation method.
%% 
% In the xATLy toolbox, the |fitgroundmodel| function is utilized to fit a curve 
% to the terrain points, resulting in both a curve fit object or function (grndFunc), 
% as well as the ground points (gpts) utilized during the fitting process, as 
% shown below.

% fit ground level
grndInterval = 10; % binning distance
interpolatemethod = 'smoothingspline';%'other options 'linearinterp','cubicspline';
robustfit = false; % no robust fitting using RANSAC. This is still experimnetal
[grndFunc, gpts] = fitgroundmodel(pc,grndInterval,interpolatemethod,robustfit);
%% 
% The following lines of code plot the point cloud together with the fitted 
% ground curve. We use tiled layout to show zoomed views of two sections of the 
% data to clearly show details on the binning and fitting.

% Visualize fitted ground surface
figure('units','normalized','outerposition',[0.0 0.0 0.85 1]);
t = tiledlayout(2,2);

nexttile(1,[1,2])
atdlim = [0,2000];
mksize =  7;
plothis = 'c';
atdplot(pc,plothis, colors, atdlim, excludenoisepts); 

hold on
cf = and(gpts(:,1) >= atdlim(1),gpts(:,1) <=atdlim(2));
hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); %

set(hh,'MarkerSize',mksize, 'LineWidth',1.5);
dg = hh(1);
dg.DisplayName = 'Bin points';
dg.Color = [0.6353 0.0784 0.1843];
dg.MarkerSize = mksize;
dg.Marker = 'x';
dg.LineWidth = 1;

cg = hh(2);
cg.DisplayName = 'Terrain fit';
cg.Color = [ 0.9412,0.8824,0.2275];
xlabel('Along-track distance (m)')
ylabel('Elevation (m)')
lg2 = legend('Orientation','horizontal','Location','southwest','NumColumns',3,'FontSize',8);
lg2.ItemTokenSize(1) = 10;
xlim([atdlim(1),atdlim(2)])
ylim([1000,1160])
hold off

nexttile
atdlim = [400,500];
atdplot(pc,plothis, colors, atdlim, excludenoisepts); 

hold on
cf = and(gpts(:,1) >= atdlim(1),gpts(:,1) <=atdlim(2));
hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); %

set(hh,'MarkerSize',mksize, 'LineWidth',1.5);
dg = hh(1);
dg.Color = [0.6353 0.0784 0.1843];
dg.MarkerSize = mksize;
dg.Marker = 'x';
dg.LineWidth = 1;

cg = hh(2);
cg.Color = [ 0.9412,0.8824,0.2275];
lg2 = legend('off');

title('')
subtitle('')
xlabel('Along-track distance (m)')
ylabel('Elevation (m)')
xlim([atdlim(1),atdlim(2)])
ylim([1000,1160])
hold off

nexttile
atdlim = [1200,1300];
atdplot(pc,plothis, colors, atdlim, excludenoisepts); 

hold on
cf = and(gpts(:,1) >= atdlim(1),gpts(:,1) <=atdlim(2));
hh = plot(grndFunc,gpts(cf,1),gpts(cf,2)); %

set(hh,'MarkerSize',mksize, 'LineWidth',1.5);
dg = hh(1);
dg.Color = [0.6353 0.0784 0.1843];
dg.MarkerSize = mksize;
dg.Marker = 'x';
dg.LineWidth = 1;

cg = hh(2);
cg.Color = [ 0.9412,0.8824,0.2275];
lg2 = legend('off');
xlabel('Along-track distance (m)')
ylabel('Elevation (m)')
title('')
subtitle('')
xlim([atdlim(1),atdlim(2)])
ylim([1000,1160])
hold off
t.TileSpacing = 'compact';
t.Padding = 'compact';
% 3. Normalize point cloud using |normalizepts| function
% Using the |normalizepts| function, the fitted ground curve model is employed 
% to estimate the ground level at each point. This estimated ground level is then 
% subtracted from the point elevation, resulting in the aboveground level heights. 
% Any points below the fitted ground curve will have negative aboveground heights. 
% The _removeptsbelow_ parameter provides the option to either remove or retain 
% these points with negative heights, as demonstrated below.

removeptsbelow = true; % gets rid of any point below fitted ground level
npc = normalizepts(pc,grndFunc, removeptsbelow);

% Visualize output
atdlim = [0,2000];
mksize =  3;

figure('units','normalized','outerposition',[0.0 0.0 0.85 0.6]);

% plot classified point cloud 
plothis = 'n'; % photn class
colors = 'rgm'; % black for noise,red = terrain etc
excludenoisepts = true; % includes noise points

atdplot(gt,plothis, colors, atdlim, excludenoisepts) 
box on
xlim([atdlim(1),atdlim(2)])
ylim([0,25])
% 4. Calculate canopy and terrain height using the h|metrics| function
% With the |hmetrics| function, canopy and terrain metrics are computed for 
% each segment utilizing normalized point cloud data. The function allows for 
% the specification of a segment length as well as a minimum number of points 
% required for a valid calculation. Additionally, multiple canopy height percentiles 
% can be included, and the minimum allowable canopy height can be controlled as 
% desired.

% calculation parameters
segLength = 30; % use 30 m segment length
canopy_percentiles = [50,98]; % calculate 50th and 98th canopy height percentiles
minpts = 9; % set min number of points for valid calculation
min_h = 2; % set min canopy height returned
includeground = true; % includes ground points in canopy height percentile calculation

% calculate canopy and terrain heights
cH = hmetrics(npc, segLength,canopy_percentiles,minpts,min_h, includeground);

% display first 5 rows, limt columns for space to:
% 1:4 -> seg_id, seg_atd, seg_lon, seg_lat
% 9:11 - > seg_npts, seg_ca_pts, seg_te_pts
% 17 -> h_ca_p98 (98th percentile canopy height)
disp(cH(1:5,[1:4,9:11,17])) 
%% 
% The |hmetrics| function outputs various attributes by default, including the 
% central segment coordinates (seg_lat/seg_lon), as well as the coordinates marking 
% the beginning (seg_lat_beg/seg_lon_beg) and end (seg_lat_end/seg_lon_end) of 
% the segment. The resulting table also includes information on the number of 
% points within the segment (seg_npts), which is further broken down into terrain 
% (seg_te_pts) and off-terrain canopy (seg_ca_pts). Additionally, the function 
% calculates default metrics such as the minimum, mean, maximum, and standard 
% deviation for both canopy and terrain heights.
% 
% The figure below shows normalized point cloud data overlain with the calculated 
% 98th percentile canopy height.

% visualize output
atdlim = [0,2000];
mksize =  3;

figure('units','normalized','outerposition',[0.2 0.0 0.85 0.6]);

% plot classified point cloud 
plothis = 'n'; % photn class
colors = 'rgm'; % black for noise,red = terrain etc
excludenoisepts = true; % includes noise points
% normalized point cloud
atdplot(npc,plothis, colors, atdlim, excludenoisepts) 
box on

% overlay with calculated 98th percentile height
hold on
clr = [0.4667 0.6745 0.1882];
ch = 'RH98'; % 98th percentile height;
tf2 = and(cH.seg_atd >= atdlim(1), cH.seg_atd <= atdlim(2));
plot(cH.seg_atd(tf2),cH.h_ca_p98(tf2),'^','Color',clr,...
                'MarkerSize',7,'LineWidth',2,'DisplayName',ch)
hold off

lg3 = legend('Orientation','vertical','Location','best','NumColumns',2,'FontSize',8);
lg3.ItemTokenSize(1) = 10;
xlim([atdlim(1),atdlim(2)])
ylim([0,30])
% Combining steps 1 -3
% In case you are only interested in calculating heights, steps 1 - 3 can be 
% combined as follows:

% parameters
inc_these_seg_attrib = {'msw_flag','night_flag'};
clip_aoi = []; % no clipping enabled
grndInterval = 10;
interpolatemethod = 'smoothingspline';
robustfit = false;
removeptsbelow = true;

% get normalized points directly
npc = gt.getnormalizedpc(inc_these_seg_attrib, clip_aoi, grndInterval,...
                interpolatemethod,robustfit, removeptsbelow);

% calculation parameters
segLength = 30; % use 30 m segment length
pcTile = [50,98]; % calculate 50th and 98th canopy height percentiles
minPts = 9; % set min number of points for valid calculation
minCH = 2; % set min canopy height returned
includeground = true; % includes ground points in canopy height percentile calculation



% calculate canopy and terrain heights
cH = hmetrics(npc, segLength,pcTile,minPts,minCH, includeground);
disp(cH(1:5,[1:4,9:11,17])) % display first 10 rows, limit columns
% Saving calculated canopy and terrain heights
% Similar to all derived attribute data, calculated canopy and terrain height 
% metrics can readily be saved as ASCII text files to facilitate further analyses. 
% The code below saves the _cH_ table retrieved in the preceding steps to a CSV 
% file using the |savetable| function

pc_fn = './temp/gt1l_tbl_ch.csv';
savetable(cH,pc_fn) % writes the classified pc
% Generate custom segment polygons
% Similar to ATL08 data, the xATLy toolbox allows for the creation of segment 
% polygons based on the custom canopy height data. These polygons can be used 
% for various tasks, including validation or metric comparison, as well as visualization 
% purposes. To generate these segment polygons, the toolbox utilizes the beginning 
% and end coordinates of each segment in addition to a set segment width that 
% approximates the lidar footprint.

segmentwidth = 11; % sets output segment width to 11 m
outshp = '.\temp\customseg.shp'; % output shapefile, WGS84 geo
clip_aoi = []; % no clipping to area of interest
writecustomsegpol(cH, outshp, segmentwidth, clip_aoi)
% Concluding remarks
% This notebook showcased the use of the xATLy toolbox for generating custom 
% canopy and terrain heights using ATL03 and ATL08 data. However, it's important 
% to note that the current version of the toolbox utilizes the ATL08 photon classification 
% data without any refinement. As a result, any errors in the ATL08 product's 
% classification may impact the accuracy of the derived canopy and terrain heights.
% 
% For additional processing options, please refer to the class methods or function 
% definitions provided in the xATLy toolbox.
##### SOURCE END #####
-->
</div></body></html>